'use client'

import { useState, useEffect } from 'react';
import { SoccerField } from '../../types';

import { MapPin, Clock, CalendarDays, PlusCircle } from 'lucide-react';
import { GiSoccerKick } from "react-icons/gi";


import Link from 'next/link';
import { useUser } from '@/context/UserContext';
import { getServerUser } from '@/app/actions/userServer';
import { getBookingsByField, getFieldIdReservations } from '@/app/actions/bookings';
//Component
//import { OccupiedSchedules } from '../reserva/CardHorasOcupadasByField'


interface FieldCardProps {
  field: SoccerField;

}


export default function FieldCard2({ field }: FieldCardProps) {
  const [error, setError] = useState<string | null>(null);
  const [bookingsData, setBookingsData] = useState<any>(null);
  const [isLoadingBookings, setIsLoadingBookings] = useState(true);
  const [user, setUser] = useState<any>(null);

  const formatTime = (dateString: string) => {
    return new Date(dateString).toLocaleTimeString([], {
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
  };
  // Esto convierte cualquier cosa (objeto o string) en un string puro
const fieldId = String(field?._id?.$oid || field?._id || "");

  useEffect(() => {
    if (!fieldId ) return;
    const loadBookings = async () => {
      //console.log("load booking ejecurandose ")
      setIsLoadingBookings(true); // Inicia carga
      try {
        const ususario = await getServerUser();
        setUser(ususario)
       const response = await getFieldIdReservations(fieldId);
     //   console.log(" response bookings ", response)
        if (response.success) {
          setBookingsData(response.content.data);
        }
      } catch (error) {
        console.error(error);
      } finally {
        setIsLoadingBookings(false); // Finaliza carga
      }
    };
    loadBookings();
  }, [fieldId]);

 // console.log("lista de reservas ", bookingsData)
//

  //console.log("field::  ", field._id)
  //console.log("field Name::  ", field.name)
  return (
    <div className="bg-brand-white rounded-xl border border-brand-gray shadow-sm
     overflow-hidden hover:shadow-md transition-all group flex flex-col h-full w-[85vw] mx-auto md:w-full">
      {/* Header de la Card */}
      <div className="p-4 flex-grow">
        <div className="flex justify-between items-start mb-2">
          <h3 className="text-lg font-bold text-brand-black group-hover:text-brand-gold transition-colors">
            {field.name.toUpperCase()}
          </h3>
          <span className={`text-[10px] font-black px-2 py-1 rounded-full uppercase ${field.state
            ? 'bg-green-100 text-green-700 border border-green-200'
            : 'bg-red-100 text-red-700 border border-red-200'
            }`}>
            {field.state ? 'Activa' : 'Inactiva'}
          </span>
        </div>

        <p className="text-gray-500 text-sm line-clamp-1 mb-4">
          {field.description}
        </p>

        <div className="space-y-2 mb-4">
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <MapPin size={16} className="text-brand-gold" />
            <span>{field.location}</span>
          </div>
          <div className="flex items-center gap-2 text-xs text-gray-600">
            <GiSoccerKick size={20} className='text-brand-gold' />
            <span>Capacidad: {field.capacity} personas</span>
          </div>
        </div>

        {/* --- SECCIÓN DE RESERVAS --- */}
        <div className="mt-4 pt-4 border-t border-dashed border-gray-200">
          <div className="flex items-center gap-1 mb-3 text-xs font-bold text-brand-black uppercase tracking-wider">
            <CalendarDays size={14} className="text-brand-gold" />
            Horarios Ocupados Hoy
          </div>
          {/*   <OccupiedSchedules bookings={bookingsData} /> */}

          <div className="flex flex-col gap-2">
          {isLoadingBookings ? (
              /* --- ESTADO SKELETON (Mientras carga) --- */
              <>
                {[1, 2,3].map((i) => (
                  <div key={i} className="flex items-center justify-between w-full animate-pulse">
                    {/* Simulación de Horario */}
                    <div className="h-6 w-36 md:w-46 bg-brand-gray/50 rounded border border-brand-gray/20"></div>
                    {/* Simulación de Estado */}
                    <div className="h-4 w-18 md:w-20 bg-brand-gray/50 rounded-sm"></div>
                  </div>
                ))}
              </>
            ) : bookingsData && bookingsData.length > 0 ? (
              /* --- LISTA DE RESERVAS (Cuando ya cargó) --- */
              bookingsData.map((booking: any, index: any) => (
                <div
                  key={booking._id?.toString() || index}
                  className="flex items-center justify-between w-full"
                >
                  {/* Bloque de Horarios */}
                  <div className="flex items-center gap-1.5 bg-brand-gray/20 border border-brand-gray/30 px-2 py-1 rounded text-[11px] font-medium text-gray-700">
                    <Clock size={12} className="text-brand-gold" />
                    <span>
                      <strong className="pr-1 text-[9px] uppercase opacity-70">Inicio</strong>
                      {formatTime(booking.startTime)}
                      <strong className="px-1 text-[9px] uppercase opacity-70">Fin</strong>
                      {formatTime(booking.endTime)}
                    </span>
                  </div>

                  {/* Estado de la Reserva */}
                  <span className={`
              text-[9px] px-2 py-0.5 rounded-sm font-bold tracking-tighter border
              ${booking.state === 'CONFIRMED'
                        ? 'bg-brand-black text-brand-gold/70 border-brand-black'
                        : 'bg-brand-gold hover:text-[10px] transition-all duration-300 hover:bg-brand-black/60 hover:text-brand-gold text-brand-black border-brand-gold'}
            `}>
                      {booking.state || 'PENDIENTE'}
                    </span>
                  </div>
                ))
              ) : (
              /* --- ESTADO VACÍO --- */
              <p className="text-[11px] text-gray-400 italic">No hay reservas para hoy</p>
            )}
          </div>
        </div>
      </div>

      {/* Footer con el Precio */}
      <div className="bg-brand-gray/10 px-5 py-3 border-t border-brand-gray flex justify-between items-center mt-auto">
        <div className="flex items-baseline gap-1">
          <span className="text-lg font-black text-brand-black">S/ {field.pricePerHour}</span>
          <span className="text-[10px] text-gray-500 font-medium uppercase">/ hora</span>
        </div>
        <Link href={`/${user?.slug}/dashboard/reservas/save?fieldId=${field._id}&name=${field.name}`}>

          <button className="flex items-center gap-2 text-xs font-bold text-brand-black bg-brand-gold px-2 py-2 rounded-md hover:bg-brand-black hover:text-brand-gold transition-all shadow-sm">
            <PlusCircle size={16} />
            Nueva Reservar
          </button>

        </Link>

      </div>
    </div>
  );
}