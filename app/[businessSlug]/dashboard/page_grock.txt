"use client";
import { useEffect, useState } from 'react';
import {
    PlusCircle, Calendar, RefreshCw, AlertCircle, LayoutDashboard
} from 'lucide-react';
import { useUser } from '@/context/UserContext';
import { redirect } from 'next/navigation';

// Acciones y tipos
import { getDashboardData } from '@/app/actions/dashboard';
import { DashboardResponse } from '@/types/dashboard';
import {
    KpiSection,
    TimelineSection,
    NextMatchAlert,
    FieldRankingSection,
    HeatmapSection
} from '@/components/dashboard/DashboardComponents';

export default function SoccerDashboard() {
    const { user } = useUser();
    if (user?.role !== 'ADMIN' && user?.role !== 'USER') {
        redirect(`/${user?.slug}/dashboard/campos`);
    }

    const currency = user?.currency?.symbol || "$";

    const [data, setData] = useState<DashboardResponse | null>(null);
    const [loading, setLoading] = useState(true);
    const [error, setError] = useState<string | null>(null);

    const fetchData = async () => {
        setLoading(true);
        try {
            const result = await getDashboardData();
            if (result.success && result.data) {
                setData(result.data);
                setError(null);
            } else {
                setError(result.error || "Error al cargar los datos");
            }
        } catch (err) {
            setError("Error de conexión con el servidor");
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, []);

    if (loading) {
        return (
            <div className="min-h-[70vh] flex flex-col items-center justify-center gap-6">
                <div className="relative">
                    <RefreshCw className="animate-spin text-brand-gold" size={64} strokeWidth={1.8} />
                    <div className="absolute inset-0 bg-brand-gold/10 rounded-full blur-xl animate-pulse-slow"></div>
                </div>
                <p className="text-brand-black/80 font-bold text-xl tracking-widest animate-pulse">
                    CARGANDO DASHBOARD...
                </p>
            </div>
        );
    }

    if (error || !data) {
        return (
            <div className="min-h-[70vh] flex items-center justify-center p-6">
                <div className="w-full max-w-md bg-white/70 backdrop-blur-xl border border-brand-black/5 rounded-3xl p-8 shadow-xl text-center space-y-6">
                    <AlertCircle className="mx-auto text-danger" size={64} strokeWidth={1.5} />
                    <h2 className="text-2xl font-black text-brand-black tracking-tight">¡Algo salió mal!</h2>
                    <p className="text-brand-black/70 font-medium">{error || "No pudimos cargar los datos"}</p>
                    <button
                        onClick={fetchData}
                        className="inline-flex items-center gap-2 px-8 py-4 bg-brand-black text-white font-bold rounded-2xl hover:bg-brand-black/90 transition-all hover:scale-[1.03] active:scale-95 shadow-lg shadow-brand-black/20"
                    >
                        <RefreshCw size={20} />
                        Reintentar
                    </button>
                </div>
            </div>
        );
    }

    return (
        <div className="min-h-screen bg-gradient-to-br from-brand-gray/40 via-brand-white to-brand-gray/30 pb-20">
            <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 lg:py-12 space-y-10 md:space-y-16">

                {/* Header moderno */}
                <header className="flex flex-col sm:flex-row sm:items-center justify-between gap-6 sticky top-0 z-10 bg-white/60 backdrop-blur-xl py-4 -mx-4 sm:-mx-6 lg:-mx-8 px-4 sm:px-6 lg:px-8 border-b border-brand-black/5">
                    <div className="flex items-center gap-5">
                        <div className="p-4 bg-brand-gold rounded-2xl shadow-lg shadow-brand-gold/30 text-brand-black">
                            <LayoutDashboard size={32} strokeWidth={1.8} />
                        </div>
                        <div>
                            <h1 className="text-4xl md:text-5xl font-black text-brand-black tracking-tight leading-none">
                                Dashboard
                            </h1>
                            <p className="text-brand-black/60 font-semibold mt-1.5">
                                Complejo deportivo • <span className="text-brand-gold font-extrabold">ABIERTO</span>
                            </p>
                        </div>
                    </div>

                    <div className="flex items-center gap-4 flex-wrap">
                        <button
                            onClick={fetchData}
                            className="p-3.5 rounded-2xl bg-white/80 backdrop-blur border border-brand-black/10 hover:bg-white hover:border-brand-gold/40 text-brand-black/70 hover:text-brand-gold transition-all duration-300"
                            aria-label="Refrescar"
                        >
                            <RefreshCw size={22} strokeWidth={2} />
                        </button>

                        <button className="hidden md:flex items-center gap-2.5 px-6 py-3.5 bg-brand-black text-white font-bold rounded-2xl hover:bg-brand-black/95 transition-all hover:shadow-xl hover:shadow-brand-black/20 active:scale-95">
                            <Calendar size={20} />
                            Bloquear horario
                        </button>

                        <button className="flex items-center gap-2.5 px-7 py-4 bg-brand-gold text-brand-black font-black text-lg rounded-2xl shadow-2xl shadow-brand-gold/40 hover:shadow-none hover:translate-y-1 transition-all duration-300 active:scale-95">
                            <PlusCircle size={22} strokeWidth={2.2} />
                            NUEVA RESERVA
                        </button>
                    </div>
                </header>

                {/* KPIs con glass effect */}
                <div className="bg-white/40 backdrop-blur-2xl border border-white/60 rounded-3xl p-6 md:p-8 shadow-xl shadow-brand-black/5">
                    <KpiSection kpis={data.kpis} currency={currency} />
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-10">

                    {/* Columna principal - Timeline */}
                    <div className="lg:col-span-2 space-y-8 lg:space-y-10">
                        <div className="bg-white/50 backdrop-blur-xl border border-white/70 rounded-3xl p-6 md:p-8 shadow-lg shadow-brand-black/5">
                            <TimelineSection bookings={data.timeline} />
                        </div>
                    </div>

                    {/* Sidebar derecha */}
                    <div className="space-y-8 lg:space-y-10 order-first lg:order-last">

                        <div className="bg-white/50 backdrop-blur-xl border border-white/70 rounded-3xl p-6 md:p-8 shadow-lg shadow-brand-black/5">
                            <NextMatchAlert nextMatch={data.proximoPartido} currency={currency} />
                        </div>

                        <div className="bg-white/50 backdrop-blur-xl border border-white/70 rounded-3xl p-6 md:p-8 shadow-lg shadow-brand-black/5">
                            <FieldRankingSection ranking={data.rankingCampos} currency={currency} />
                        </div>

                        <div className="bg-white/50 backdrop-blur-xl border border-white/70 rounded-3xl p-6 md:p-8 shadow-lg shadow-brand-black/5">
                            <HeatmapSection items={data.mapaCalor} />
                        </div>

                    </div>
                </div>

            </div>
        </div>
    );
}