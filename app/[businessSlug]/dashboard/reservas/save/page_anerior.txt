"use client";
import { useState, useEffect } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import dayjs from '@/lib/dayjs'; // Importa tu configuración//para formaterar fechas
import { useUser } from '@/context/UserContext';
import { createBooking, getBookingsByField } from "@/app/actions/bookings";
import { createPayment } from '@/app/actions/payments';
import HorasOcupadas from '@/components/campos/HorasOcupadas';

// Componentes modularizados
import { StepIndicator } from "@/components/pagos/modulos/StepIndicator";
import { BookingForm } from "@/components/pagos/modulos/BookingForm";
// Correct the path to the PaymentForm module
import { PaymentForm } from "@/components/pagos/modulos/PaymentForm";
import { SuccessState } from "@/components/pagos/modulos/SuccessState";
import { setTimeout } from "timers";

type Step = 'BOOKING' | 'PAYMENT' | 'SUCCESS';

export default function CreateBookingPage() {
    const router = useRouter();
    const searchParams = useSearchParams();
    const fieldId = searchParams.get("fieldId");
    const fieldName = searchParams.get("name");
    console.log("field Name ", fieldName)
    const { user } = useUser();
    
    const [step, setStep] = useState<Step>('BOOKING');
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState<string | null>(null);
    const [fieldData, setFieldData] = useState<any>(null);
    const [bookingResponse, setBookingResponse] = useState<any>(null);
    const [showDiscount, setShowDiscount] = useState(false);

    const [bookingData, setBookingData] = useState({
        userId: "", fieldId: "", fieldName: "", date: "", time: "", durationInMinutes: 60
    });

    const [paymentData, setPaymentData] = useState({
        paymentMethod: 'CASH', nameCustomer: "", dniCustomer: "", descuento: 0
    });
  
   console.log("user desde save reserva ", user)

    // Efectos de carga de datos iniciales
    if(!user)return console.log("NO HAY USER.......");
    useEffect(() => {
        if (user || fieldId) {
            setBookingData(prev => ({ ...prev, userId: user?.uid || "", fieldId: fieldId || "", fieldName: fieldName || "" }));
        }
    }, [user, fieldId, fieldName]);

    useEffect(() => {
            const loadBookings = async () => {
                if(!fieldId)return setError("no hay id del campo")
                const response = await getBookingsByField(fieldId);

                if (response.success) {
                    // response.data es lo que vino de tu await res.json()
                    setFieldData(response.content.data); 
                    console.log("field adta desde effec", fieldData)
                } else {
                    //toast.error(response.message);
                    setError("NO se cargaron los datos correactamente")
                    setTimeout( () => {
                        setError("")
                    }, 2000);
                }
            };
            loadBookings()
    }, [fieldId, user]); 
    
    console.log(" desde save reserva ", fieldData)



    const handleBookingSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);

// 1. Combinamos fecha y hora manualmente
  // bookingData.date viene como "YYYY-MM-DD"
  // bookingData.time viene como "HH:mm"
/*   const combinedDateTime = `${bookingData.date}T${bookingData.time}:00`;
  
  // 2. Creamos el objeto Date (esto lo toma en la hora local del usuario)
  const localDate = new Date(combinedDateTime);

  // 3. Lo convertimos a ISO para el backend
  const isoStartTime = localDate.toISOString(); */

  // Ahora envías isoStartTime al backend

  ///       nuevo con day.js
  // 1. Combinamos fecha y hora
  const combinedDateTime = `${bookingData.date}T${bookingData.time}`;
  
  // 2. Creamos el objeto dayjs
  // Esto lo interpreta como hora local del navegador automáticamente
  const localDate = dayjs(combinedDateTime);

  // 3. LA CLAVE: Enviar el string con el offset local
  // .format() sin argumentos devuelve: "2026-02-06T20:00:00-05:00"
  // Esto le dice al backend exactamente qué hora es y en qué zona horaria está
  const startTimeForBackend = localDate.format();

  //validar que no registre en el pasado
  const today = dayjs().format('YYYY-MM-DD');

// Al validar antes de enviar:
const isPast = dayjs(`${bookingData.date}T${bookingData.time}`).isBefore(dayjs());

if (isPast) {
  alert("No puedes reservar en el pasado");
  return;
}

       // const startTimeISO = new Date(`${bookingData.date}T${bookingData.time}:00`).toISOString();
        
        const result = await createBooking({
            userId: bookingData.userId,
            fieldId: bookingData.fieldId,
            startTime: startTimeForBackend,
            durationInMinutes: Number(bookingData.durationInMinutes),
        });

        if (result.success) {
            setBookingResponse(result.data);
            setStep('PAYMENT');
           // console.log(" result desde page ", result)
        } else {
            setError(result.error);
            setTimeout(()=>{
                setError("")
            },2000)
        }
        setLoading(false);
    };
console.log("boking response ", bookingResponse)
    const handlePaymentSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        const basePrice = Number(bookingResponse.totalPrice) || 0;
        const discountMoney = (basePrice * (Number(paymentData.descuento) / 100));
        console.log("user desde habdle payment ", user)

        const result = await createPayment({
            bookingId: bookingResponse._id,
            userId: user?.uid!,
            amount: basePrice,
            descuento: discountMoney,
            total: basePrice - discountMoney,
            paymentMethod: paymentData.paymentMethod as any,
            nameCustomer: paymentData.nameCustomer || "Consumidor final",
            dniCustomer: paymentData.dniCustomer
        });

        if (result.success) {
            setStep('SUCCESS');
            setTimeout(() => router.push(`/${user?.slug}/dashboard/campos`), 1500);
        } else {
            setError(result.error);
        }
        setLoading(false);
    };

  
    return (
        <div className="min-h-screen bg-gray-50 p-4 md:p-8 flex flex-col items-center">
          {
            fieldData && fieldData.length > 0 && (
              <HorasOcupadas bookings={fieldData} selectedDate={bookingData.date} />
            )}  
            
            <StepIndicator step={step} />

            <div className="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
                <div className="bg-brand-black p-6 text-center">
                    <h1 className="text-2xl font-bold text-brand-gold uppercase">{step === 'BOOKING' ? 'Nueva Reserva' : 'Pago'}</h1>
                </div>

                <div className="p-8">
                    {error && <div className="mb-4 text-red-500 text-xs font-bold text-center">{error}</div>}
                    
                    {step === 'BOOKING' && <BookingForm bookingData={bookingData} setBookingData={setBookingData} onSubmit={handleBookingSubmit} loading={loading} />}
                    {step === 'PAYMENT' && <PaymentForm fieldData={fieldData} paymentData={paymentData} setPaymentData={setPaymentData} bookingResponse={bookingResponse} showDiscount={showDiscount} setShowDiscount={setShowDiscount} onSubmit={handlePaymentSubmit} loading={loading} user={user} />}
                    {step === 'SUCCESS' && <SuccessState />}
                </div>
            </div>
        </div>
    );
}